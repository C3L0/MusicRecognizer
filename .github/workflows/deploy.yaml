name: CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # --- JOB 1 : TESTS ---
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: uv sync

      - name: Run Tests
        # C'est ici que tu lances tes scripts de test
        # Si cette commande Ã©choue, le job 'deploy' ne se lancera pas
        run: |
          uv run pytest tests/ 

  # --- JOB 2 : DEPLOY ---
  deploy:
    runs-on: ubuntu-latest
    needs: test # <--- CRUCIAL : Attend que les tests passent
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true

      - name: Push to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git push --force https://c3loo:$HF_TOKEN@huggingface.co/spaces/c3loo/sounds_recognizer main